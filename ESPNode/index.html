<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ESPNode: ESPNode</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">ESPNode
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">ESPNode </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md__home_norbert_projekte_ESPNode_README"></a></p>
<h1><a class="anchor" id="autotoc_md1"></a>
brief description</h1>
<p>ESPNode is a firmware for ESP8266 and ESP32 (in future). This firmware is not generic, it has to be configured and compiled for each individual node.</p>
<h3><a class="anchor" id="autotoc_md2"></a>
Features:</h3>
<ul>
<li>Implemented RF24 Gateway for my RF24Hub (<a href="https://github.com/wilmsn/RF24Hub">https://github.com/wilmsn/RF24Hub</a>)</li>
<li>Implemented MQTT Client</li>
<li>Web Interface (based on J-Query and Websockets)</li>
<li>Written in C++ for Arduino</li>
</ul>
<p><img src="https://wilmsn.github.io/ESPNode/espnode.png" alt="ESPNode Komponenten" class="inline"/></p>
<p>ESPNode as a part of RF24Hub</p>
<p><img src="https://wilmsn.github.io/ESPNode/einbindung.png" alt="Einbindung des ESPNode in den RF24Hub" class="inline"/></p>
<p>The main documentation of this projekt is in german language.</p>
<p><a href="http://wilmsn.github.io/ESPNode/index.html">Programmdoku auf wilmsn.github.io/ESPNode</a></p>
<h1><a class="anchor" id="autotoc_md3"></a>
Hauptprogramm</h1>
<p>Details zum Hauptprogramm gibt es in der <a href="http://wilmsn.github.io/ESPNode/index.html">Programmdoku</a>, hier wird nur das zugrundeliegende Konzept beschrieben. Im Hauptprogramm sind folgende Komponenten vorgesehen:</p>
<ul>
<li>Einbau von bis zu 4 Schaltern</li>
<li>Einbau von bis zu 2 Sensoren (Hardware) mit bis zu 4 Messwerten in Summe</li>
</ul>
<p>Sofern die Module/Objektdefinitionen bereits vorhanden sind, kann das Programm einfach durch Konfiguration angepasst werden. Ohne Konfiguration sind alle Elemente deaktiviert. Details über die Konfiguration sind <a href="#konfiguration">hier</a> zu finden</p>
<p>Initialisierung des Hauptprogrammes: Hier werden nacheinander folgende Dinge erledigt:</p>
<ul>
<li>Verbindung mit dem WLAN (es werden die 2 konfigurierten Netze getestet)</li>
<li>Öffnen des internen Filesystems</li>
<li>Starten des Webservers</li>
<li>Starten des RF24 Gateways (falls aktiviert)</li>
<li>Ausführen der BEGIN Staements aller Sensoren und Switches</li>
<li>Starten des Messvorgangs aller Sensoren</li>
<li>Start des MQTT Clients</li>
</ul>
<p>Danach ist das Programm initialisiert und läuft in einer Endlosschleife. Innerhalb der Schleife finden (zum Teil zeitgesteuert) folgende Aktionen statt:</p>
<ul>
<li>RF24 Gateway (falls aktiviert): Prüfen ob neue Datenpakete anliegen, wenn ja dann an den Hub weiterleiten</li>
<li>MQTT auf Pakete prüfen und veraarbeiten</li>
<li><a class="el" href="main_8cpp.html#afe461d27b9c48d5921c00d521181f12f" title="Die Hauptschleife.">loop()</a> Funktion aller Sensoren und Switches bedienen</li>
</ul>
<p>Zeitabhängige Aktionen:</p>
<ul>
<li>Telemetriedaten senden (var: TELEINTERVAL)</li>
<li>Messungen starten (var: STATINTERVAL)</li>
<li>Statusdaten und Messwerte senden (var: MESSINTERVAL)</li>
</ul>
<h1><a class="anchor" id="autotoc_md4"></a>
Sensormodule</h1>
<p>Sensormodule beschreiben bzw erzeugen eigene Objekte. Die Einbindung erfolgt über die Datei **"Node_settings.h"**. Dort müssen die nachfolgenden Funktionen vorhanden und mit Inhalt gefüllt sein. Zur Kompatibilität sind die Funktionen als Leerfunktion im Grundobjekt **"Sensor_Generic"** bereits vorhanden. Alle neuen Objekte für Sensoren und Aktoren werden von **"Sensor_Generic"** abgeleitet.</p>
<h2><a class="anchor" id="autotoc_md5"></a>
Funktion "begin()"</h2>
<p>Dies Funktion kann je nach Einsatz und Aufgabe unterschiedliche Parameter erfordern. Damit die Funktion universell eingebaut werden kann, erfolgt ihr "Einbau" in der Datei **"Node_settings.h"** über eine Precompiler Direktive. Beispiel: </p><pre class="fragment">#include "sensor_18B20.h"
#define SENSOR1_DEFINITION       Sensor_18B20 sensor1;
#define SENSOR1_BEGIN_STATEMENT  sensor1.begin("sens1","Temperatur","Temperatur");
</pre><p> In der ersten Zeile wird die Headerdatei für die Objektdefinition eingebunden. In der zweiten Zeile das Objekt definiert. Die Direktive **"SENSOR1_DEFINITION"** MUSS für den ersten Sensor verwendet werden. Gibt es weitere Sensoren, gibt es im Programm eine Vorbereitung für 3 Sensoren (SENSOR1 bis SENSOR3) und 4 Aktoren (SWITCH1 bis SWITCH4). Liefert eine Hardware mehrere Messwerte, wird diese als ein Sensor implementiert (siehe "sensor_bosch.h/cpp". Die Objektdefinition ist hier "Sensor_18B20". Dieser Ausdruck ist variabel und entspricht dem der Definition. Das erzeugte Objekt heist "sensor1".</p>
<p>In die Variable <b>obj_sensorinfo</b> wird ein Teil-JSON mit allen unter Sysinfo anzuzeigenden Sensorinfos angelegt.</p>
<p>Syntax: **"sensorinfo1 : Sensordetails linke Spalte # Sensordetails rechte Spalte"**</p>
<p>In der Webseite ist Platz für **"sensorinfo1"** bis **"sensorinfo5"** vorgesehen</p>
<p>Innerhalb des Programmes wird in diesem Schritt alles nötige getan um das Objekt zu initalisieren und alle Werte auf Startwerte gesetzt.</p>
<p>Die Implementierung erfolgt wiederum über eine Precompilerdirektive (Zeile3): Der erste Teil "SENSOR1_BEGIN_STATEMENT" ist statisch. Der zweite Teil wird entsprechend der benötigten Objektinitialisierung angepasst.</p>
<h2><a class="anchor" id="autotoc_md6"></a>
Funktion "start_measure()"</h2>
<p>Innerhalb dieser Funktion muss bei einem Sensor zwingend folgendes Programmiert werden:</p>
<p>1) Alles nötige zum Auslesen des oder der Messwerte.</p>
<p>2) Befüllung folgender Variablen (vordefiniert in "Sensor_Generic")</p>
<p>2.a) **"obj_html_stat_json"** Hier muss ein kompletter gültiger JSON eingetragen mit dem/den aktuellen Messwert(en) eingetragen werden.</p>
<p>Syntax: **{"Einbauplatz" : "Anzuzeigender Schriftzug"}**</p>
<p>Beispiel: **{"sens1" : "Temperatur 21 °C"}**</p>
<p>2.b) **"obj_mqtt_json"** Hier muss ein Teil-JSON für alle Messwerte zur Übertragung mittels MQTT eingetragen werden.</p>
<p>Syntax: **{"Messwertlabel" : "Wert"}**</p>
<p>Beispiel: **{"Temperatur" : 21.2 }**</p>
<h2><a class="anchor" id="autotoc_md7"></a>
Funktion set( keyword, value)</h2>
<p>Diese Funktion muss für jeden Aktor/Switch gefüllt werden. Innerhalb des Hauptprogrammes werden alle Befehle (Format Item=value) durch jede set funktion der eingebauten Objekte geschleust. Die Objekte prüfen ob das Item für sie ein keyword ist und sie handeln müssen. Die benötigte Funktion für diese Prüfing ist im generischen Basisobjekt als Funktion <b>keyword_match</b> hinterlegt. Nach Beendigung der Funktion müssen auch hier die Variablen **"obj_html_stat_json"** und **"obj_mqtt_json"** gefüllt sein.</p>
<h2><a class="anchor" id="autotoc_md8"></a>
Funktion "html_create_json_part(json)"</h2>
<p>Ein Sensor aktiviert seine Anzeige selbst indem der anzuzeigende Wert in das passende HTML Feld geschrieben wird. Bei einem Aktor/Switch muss dazu die Funktion "html_create_json_part" gefüllt werden. Durch das hier erzeugte JSON wird festgelgt was wie auf der HTML Seite angezeigt wird. Dabei gibt es folgende Möglichkeit:</p>
<p>a) Reiner Ein-Aus Schalter</p>
<p>Codesegment: **"sw1 : 0 , sw1_label : Lichtschalter , sw1_format : x"**</p>
<p>b) Schalter mit Regler</p>
<p>Codesegment: **"sw1 : 0 , sw1_label : Lichtschalter , sw1_format : x, slider1 : 1 , slider1label : Helligkeit , slider1val : 54"**</p>
<p>c) Jede andere Kombination die nach Änderung der HTML Seite benötigt wird</p>
<p>Beispiele dazu in der Datei <a class="el" href="switch__onoff_8h.html">switch_onoff.h</a>/cpp</p>
<h1><a class="anchor" id="autotoc_md9"></a>
Konfiguration</h1>
</div></div><!-- PageDoc -->
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
